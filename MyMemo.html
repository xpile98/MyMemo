<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite Canvas with Movable Memo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #f0f0f0;
        }
        #canvas {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        #canvas-content {
            position: absolute;
            transform-origin: 0 0;
            background-color: white;
            opacity: 0.8; /* Background transparency set to 0.8 */
        }
        .memo-wrapper {
            position: absolute;
        }
        .memo {
            width: 200px;
            height: 200px;
            background-color: #ffff99; /* Default memo color changed to yellow */
            padding: 10px;
            box-sizing: border-box;
            overflow: hidden;
            cursor: move;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .memo-icons {
            position: absolute;
            top: -30px;
            right: 0px; /* right ÏÜçÏÑ±ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Ïò§Î•∏Ï™ΩÏóê ÏúÑÏπò */
            display: none;
            justify-content: center;
            gap: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 5px;
            z-index: 1000;
            white-space: nowrap; /* Prevent icons from wrapping */
        }
        .memo-wrapper:hover .memo-icons,
        .memo-wrapper:hover .resize-handle {
            display: flex;
        }
        .color-icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
            border-radius: 50%;
        }
        .icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .resize-handle {
            position: absolute;
            right: 5px;
            bottom: 5px;
            cursor: nwse-resize;
            width: 20px;
            height: 20px;
            display: none;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }
        .memo-content {
			width: 100%;
			height: 100%;
			border: none;
			background-color: transparent;
			resize: none;
			cursor: move;
		}

		.memo-content:not([readonly]) {
			cursor: text;
		}
        .image-container {
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        #menu-icon {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
            cursor: pointer;
            font-size: 24px;
        }
        #menu {
            position: fixed;
            top: 40px;
            right: 10px;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            display: none;
            z-index: 1001;
        }
        #context-menu div {
            padding: 5px 10px;
            cursor: pointer;
        }

        #context-menu div:hover {
            background-color: #eee;
        }

    </style>
</head>
<body>
    <div id="context-menu" style="display: none; position: absolute; z-index: 10000; background-color: white; border: 1px solid #ccc; padding: 10px; box-shadow: 0px 0px 5px rgba(0,0,0,0.2);">
        <div id="bring-to-front">Bring to Front</div>
        <div id="send-to-back">Send to Back</div>
    </div>    
    <div id="canvas">
        <div id="canvas-content"></div>
    </div>
    <div id="menu-icon">‚ò∞</div>
    <div id="menu">
        <h3>Canvas Settings</h3>
        <label for="background-selector">Background:</label>
        <select id="background-selector" onchange="changeBackground(this.value)">
            <option value="none">None</option>
            <option value="grid">Grid</option>
            <option value="dot">Dot</option>
            <option value="legal">Legal</option>
        </select>
        <br><br>
        <label for="canvas-size-selector">Canvas Size:</label>
        <select id="canvas-size-selector" onchange="setCanvasSize(this.value)">
            <option value="custom">Custom</option>
            <option value="A3">A3 (297mm x 420mm)</option>
            <option value="A4">A4 (210mm x 297mm)</option>
            <option value="A5">A5 (148mm x 210mm)</option>
            <option value="B4">B4 (250mm x 353mm)</option>
            <option value="Letter">Letter (216mm x 279mm)</option>
        </select>
        <br><br>
        <label for="canvas-width">Custom Width (px):</label>
        <input type="number" id="canvas-width" min="100" step="100">
        <br>
        <label for="canvas-height">Custom Height (px):</label>
        <input type="number" id="canvas-height" min="100" step="100">
        <br>
        <br>
        <label for="canvas-orientation-selector">Orientation:</label>
        <select id="canvas-orientation-selector" onchange="setCanvasOrientation(this.value)">
            <option value="portrait">Portrait (ÏÑ∏Î°úÎ™®Îìú)</option>
            <option value="landscape">Landscape (Í∞ÄÎ°úÎ™®Îìú)</option>
        </select>

        <br><br>
        <button onclick="resizeCanvas()">Apply Custom Size</button>

        <br><br>
        <h3>Export / Import</h3>
        <button onclick="exportMemos()">Export to .memo</button>
        <input type="file" id="importFileInput" accept=".memo" onchange="importMemos(event)" style="display: none;">
        <button onclick="document.getElementById('importFileInput').click()">Import from .memo</button>
    </div>


    <script>
        const canvas = document.getElementById('canvas');
        const canvasContent = document.getElementById('canvas-content');
        const menuIcon = document.getElementById('menu-icon');
        const menu = document.getElementById('menu');

        let isResizing = false;
        let isDraggingCanvas = false;
        let isContextMenuOpen = false;
        let activeMemo = null;
        let lastX = 0;
        let lastY = 0;
        let scale = 1;
        let memoOffsetX = 0;
        let memoOffsetY = 0;
        let highestZIndex = 1;
        let lowestZIndex = 1;

        // Canvas panning
        canvas.addEventListener('mousedown', function(e) {
            if (e.button === 0) { // ÏôºÏ™Ω ÎßàÏö∞Ïä§ Î≤ÑÌäºÏóê ÌïúÏ†ï
                startDraggingCanvas(e);
            }
        });
        canvas.addEventListener('mousedown', startDraggingCanvas);
        canvas.addEventListener('mousemove', drag);
        canvas.addEventListener('mouseup', stopDragging);
        canvas.addEventListener('mouseleave', stopDragging);

        // Zooming
        canvas.addEventListener('wheel', zoom);

        // Double click to create memo (using event delegation)
        canvasContent.addEventListener('dblclick', handleDoubleClick);

        // Menu toggle
        menuIcon.addEventListener('click', toggleMenu);

        function handleDoubleClick(e) {
            if (e.target === canvasContent) {
                createMemo(e);
            }
        }

        function createMemo(e) {
            const canvasRect = canvas.getBoundingClientRect();
            const canvasTransform = new DOMMatrix(getComputedStyle(canvasContent).transform);
            const x = (e.clientX - canvasRect.left - canvasTransform.e) / scale;
            const y = (e.clientY - canvasRect.top - canvasTransform.f) / scale;

            const memoWrapper = document.createElement('div');
            memoWrapper.className = 'memo-wrapper';
            memoWrapper.style.left = `${x}px`;
            memoWrapper.style.top = `${y}px`;

            const memoId = Date.now();
            memoWrapper.innerHTML = `
                <div class="memo-icons">
                    <div class="color-icon" style="background-color: #ffff99;" onclick="changeColor(this, '#ffff99')"></div>
                    <div class="color-icon" style="background-color: #ffcccb;" onclick="changeColor(this, '#ffcccb')"></div>
                    <div class="color-icon" style="background-color: #ffffe0;" onclick="changeColor(this, '#ffffe0')"></div>
                    <div class="color-icon" style="background-color: #e0ffff;" onclick="changeColor(this, '#e0ffff')"></div>
                    <div class="color-icon" style="background-color: #98fb98;" onclick="changeColor(this, '#98fb98')"></div>
                    <div class="color-icon" style="background-color: #dda0dd;" onclick="changeColor(this, '#dda0dd')"></div>
                    <label for="image-upload-${memoId}" class="icon">üñºÔ∏è</label>
                    <input id="image-upload-${memoId}" type="file" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                    <div class="icon" onclick="deleteMemo(this)">‚úñÔ∏è</div>
                </div>
                <div class="memo">
					<textarea class="memo-content" readonly></textarea>
					<div class="image-container">
						<img src="" alt="Uploaded image">
					</div>
				</div>
                <div class="resize-handle">‚§°</div>
            `;

            canvasContent.appendChild(memoWrapper);

            const memo = memoWrapper.querySelector('.memo');
            memo.addEventListener('mousedown', function(e) {
                if (e.button === 0) { // ÏôºÏ™Ω ÎßàÏö∞Ïä§ Î≤ÑÌäº ÌÅ¥Î¶≠Ïùº ÎïåÎßå
                    startDraggingMemo(e);
                }
            });

            const resizeHandle = memoWrapper.querySelector('.resize-handle');
            resizeHandle.addEventListener('mousedown', startResizing);
			
			const memoContent = memoWrapper.querySelector('.memo-content');
			memoContent.addEventListener('dblclick', enableEditMode);
			memoContent.addEventListener('blur', disableEditMode);

            saveMemos();
        }

		function enableEditMode(e) {
			e.target.readOnly = false;
			e.target.focus();
		}

		function disableEditMode(e) {
			e.target.readOnly = true;
			saveMemos();
		}

        function startDraggingCanvas(e) {
            if (e.target === canvas || e.target === canvasContent) {
                isDraggingCanvas = true;
                lastX = e.clientX;
                lastY = e.clientY;
            }
        }

        function startDraggingMemo(e) {
            // Ïö∞ÌÅ¥Î¶≠ Ï§ëÏóêÎäî ÎìúÎûòÍ∑∏ ÏãúÏûëÏùÑ Î¨¥Ïãú
            if (isContextMenuOpen) {
                return;
            }

            const memoWrapper = e.target.closest('.memo-wrapper');
            const memoContent = memoWrapper.querySelector('.memo-content');

            // ÌÖçÏä§Ìä∏Í∞Ä Ìé∏Ïßë Î™®ÎìúÏù∏ÏßÄ ÌôïÏù∏
            if (memoContent && !memoContent.readOnly) {
                // Ìé∏Ïßë Î™®ÎìúÎùºÎ©¥ Ïù¥ÎèôÌïòÏßÄ ÏïäÎèÑÎ°ù Ìï®Ïàò Ï¢ÖÎ£å
                return;
            }

            if (memoWrapper && e.target !== memoWrapper.querySelector('.resize-handle') && 
                !e.target.closest('.memo-icons')) {
                activeMemo = memoWrapper;
                const canvasRect = canvas.getBoundingClientRect();
                const memoRect = memoWrapper.getBoundingClientRect();
                memoOffsetX = (e.clientX - memoRect.left) / scale;
                memoOffsetY = (e.clientY - memoRect.top) / scale;
                e.preventDefault();
            }
        }


        function drag(e) {
            if (isDraggingCanvas) {
                const dx = e.clientX - lastX;
                const dy = e.clientY - lastY;
                const currentTransform = new DOMMatrix(getComputedStyle(canvasContent).transform);
                canvasContent.style.transform = currentTransform.translate(dx / scale, dy / scale).toString();
                lastX = e.clientX;
                lastY = e.clientY;
            } else if (activeMemo && !isContextMenuOpen) {
                const canvasRect = canvas.getBoundingClientRect();
                const canvasTransform = new DOMMatrix(getComputedStyle(canvasContent).transform);
                const x = (e.clientX - canvasRect.left - canvasTransform.e) / scale - memoOffsetX;
                const y = (e.clientY - canvasRect.top - canvasTransform.f) / scale - memoOffsetY;
                activeMemo.style.left = `${x}px`;
                activeMemo.style.top = `${y}px`;
            }
        }

        function stopDragging() {
            isDraggingCanvas = false;
            if (activeMemo && !isContextMenuOpen) {
                saveMemos();
                activeMemo = null;
            }
        }

        function zoom(e) {
            e.preventDefault();
            const zoomIntensity = 0.1;
            const wheel = e.deltaY < 0 ? 1 : -1;
            const zoomFactor = Math.exp(wheel * zoomIntensity);

            const boundingRect = canvas.getBoundingClientRect();
            const x = (e.clientX - boundingRect.left) / scale;
            const y = (e.clientY - boundingRect.top) / scale;

            const currentTransform = new DOMMatrix(getComputedStyle(canvasContent).transform);
            const newScale = currentTransform.a * zoomFactor;

            if (newScale > 0.1 && newScale < 10) {
                const scaleDiff = newScale - currentTransform.a;
                currentTransform.a = currentTransform.d = newScale;
                currentTransform.e -= x * scaleDiff;
                currentTransform.f -= y * scaleDiff;
                canvasContent.style.transform = currentTransform.toString();
                scale = newScale;
            }
        }

        function changeColor(element, color) {
            element.closest('.memo-wrapper').querySelector('.memo').style.backgroundColor = color;
            saveMemos();
        }

        function handleImageUpload(input) {
            const file = input.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const memoWrapper = input.closest('.memo-wrapper');
                    const imageContainer = memoWrapper.querySelector('.image-container');
                    const uploadedImage = imageContainer.querySelector('img');
                    const memoContent = memoWrapper.querySelector('.memo-content');
                    
                    uploadedImage.src = e.target.result;
                    memoContent.style.display = 'none';
                    imageContainer.style.display = 'flex';
                    memoContent.value = '';

                    saveMemos();
                };
                reader.readAsDataURL(file);
            }
        }

        function deleteMemo(element) {
            element.closest('.memo-wrapper').remove();
            saveMemos();
        }

        function startResizing(e) {
            isResizing = true;
            const memoWrapper = e.target.closest('.memo-wrapper');
            e.preventDefault();
            e.stopPropagation();
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);

            function resize(e) {
                if (isResizing) {
                    const canvasRect = canvas.getBoundingClientRect();
                    const canvasTransform = new DOMMatrix(getComputedStyle(canvasContent).transform);
                    const x = (e.clientX - canvasRect.left - canvasTransform.e) / scale;
                    const y = (e.clientY - canvasRect.top - canvasTransform.f) / scale;
                    const memoRect = memoWrapper.getBoundingClientRect();
                    const newWidth = x - (memoRect.left - canvasRect.left - canvasTransform.e) / scale;
                    const newHeight = y - (memoRect.top - canvasRect.top - canvasTransform.f) / scale;
                    memoWrapper.querySelector('.memo').style.width = `${newWidth}px`;
                    memoWrapper.querySelector('.memo').style.height = `${newHeight}px`;
                }
            }

            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
                saveMemos();
            }
        }

        function changeBackground(value) {
            switch(value) {
                case 'grid':
                    canvasContent.style.backgroundImage = 'linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px)';
                    canvasContent.style.backgroundSize = '20px 20px';
                    break;
                case 'dot':
                    canvasContent.style.backgroundImage = 'radial-gradient(circle, #000 1px, transparent 1px)';
                    canvasContent.style.backgroundSize = '20px 20px';
                    break;
                case 'legal':
                    canvasContent.style.backgroundImage = 'linear-gradient(#000 1px, transparent 1px)';
                    canvasContent.style.backgroundSize = '100% 33.33px';
                    break;
                default:
                    canvasContent.style.backgroundImage = 'none';
            }
            saveCanvasSettings();
        }

        function toggleMenu() {
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function setCanvasSize(size) {
			const widthInput = document.getElementById('canvas-width');
			const heightInput = document.getElementById('canvas-height');

			switch (size) {
				case 'A3':
					widthInput.value = 3508;
					heightInput.value = 4961;
					break;
				case 'A4':
					widthInput.value = 2480;
					heightInput.value = 3508;
					break;
				case 'A5':
					widthInput.value = 1748;
					heightInput.value = 2480;
					break;
				case 'B4':
					widthInput.value = 2953;
					heightInput.value = 4169;
					break;
				case 'Letter':
					widthInput.value = 2550;
					heightInput.value = 3300;
					break;
				default:
					return; // 'Custom' ÏÑ†ÌÉù Ïãú ÏïÑÎ¨¥ ÏûëÏóÖÎèÑ ÌïòÏßÄ ÏïäÏùå
			}

			resizeCanvas();
		}

        function setCanvasOrientation(orientation) {
            const widthInput = document.getElementById('canvas-width');
            const heightInput = document.getElementById('canvas-height');
            
            let width = parseInt(widthInput.value);
            let height = parseInt(heightInput.value);

            if (orientation === 'landscape' && height > width) {
                // Í∞ÄÎ°úÎ™®ÎìúÎ°ú Î≥ÄÍ≤Ω: Ìè≠Í≥º ÎÜíÏù¥ ÍµêÌôò
                widthInput.value = height;
                heightInput.value = width;
            } else if (orientation === 'portrait' && width > height) {
                // ÏÑ∏Î°úÎ™®ÎìúÎ°ú Î≥ÄÍ≤Ω: Ìè≠Í≥º ÎÜíÏù¥ ÍµêÌôò
                widthInput.value = height;
                heightInput.value = width;
            }

            resizeCanvas();
        }


        function resizeCanvas() {
			const width = document.getElementById('canvas-width').value;
			const height = document.getElementById('canvas-height').value;
			canvasContent.style.width = `${width}px`;
			canvasContent.style.height = `${height}px`;
			saveCanvasSettings();
		}

        // Îç∞Ïù¥ÌÑ∞ ÏïïÏ∂ï Î∞è Base64 Ïù∏ÏΩîÎî©
        function compressAndEncode(data) {
            const jsonString = JSON.stringify(data);
            const compressed = pako.deflate(jsonString); // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Uint8Array Î∞òÌôò
            // Uint8ArrayÎ•º Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò ÌõÑ Base64 Ïù∏ÏΩîÎî©
            const binaryString = Array.from(compressed, byte => String.fromCharCode(byte)).join('');
            return btoa(binaryString);
        }

        // Base64 ÎîîÏΩîÎî© Î∞è ÏïïÏ∂ï Ìï¥Ï†ú
        function decodeAndDecompress(encodedData) {
            const binaryString = atob(encodedData);
            const charCodes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                charCodes[i] = binaryString.charCodeAt(i);
            }
            const decompressed = pako.inflate(charCodes, { to: 'string' });
            return JSON.parse(decompressed);
        }

        function saveMemos() {
            const memos = Array.from(document.querySelectorAll('.memo-wrapper')).map(memo => {
                const memoContent = memo.querySelector('.memo-content');
                const imageContainer = memo.querySelector('.image-container');
                let imageSrc = "";

                if (imageContainer && imageContainer.querySelector('img').src) {
                    // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏùÑ ÎïåÎßå src Í∞íÏùÑ Ï†ÄÏû•
                    const imgSrc = imageContainer.querySelector('img').src;
                    imageSrc = imgSrc.startsWith("data:image/") ? imgSrc : "";
                }

                return {
                    left: memo.style.left,
                    top: memo.style.top,
                    width: memo.querySelector('.memo').style.width,
                    height: memo.querySelector('.memo').style.height,
                    backgroundColor: memo.querySelector('.memo').style.backgroundColor,
                    content: memoContent.value,
                    imageSrc: imageSrc, // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ Îπà Î¨∏ÏûêÏó¥ÏùÑ Ï†ÄÏû•
                    zIndex: memo.style.zIndex // z-index Í∞í Ï†ÄÏû• (Í∏∞Î≥∏Í∞í 1)
                };
            });

            // Îç∞Ïù¥ÌÑ∞ Î°úÏª¨ Ï†ÄÏû• Î∞©Ïãù
            localStorage.setItem('memos', JSON.stringify(memos));

            // Í∞ùÏ≤¥Î•º JSON Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôòÌïòÍ≥† URL Ïù∏ÏΩîÎî©
            // const memoData = encodeURIComponent(JSON.stringify(memos));
            // window.location.hash = memoData;

            // Í∞ùÏ≤¥Î•º JSON Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôòÌïòÍ≥† URL Ïù∏ÏΩîÎî© + ÏïïÏ∂ï
            // const encodedData = compressAndEncode(memos);
            // window.location.hash = encodedData;
        }




        function saveCanvasSettings() {
            const settings = {
                background: document.getElementById('background-selector').value,
                width: canvasContent.style.width,
                height: canvasContent.style.height,
                size: document.getElementById('canvas-size-selector').value,
                orientation: document.getElementById('canvas-orientation-selector').value
            };
            localStorage.setItem('canvasSettings', JSON.stringify(settings));
        }


        function loadMemos() {
            // Îç∞Ïù¥ÌÑ∞ Î°úÏª¨ Î°úÎìú Î∞©Ïãù
            const savedMemos = JSON.parse(localStorage.getItem('memos'));

            //const memoData = window.location.hash.substring(1); // Ìï¥Ïãú(#) Î∂ÄÎ∂ÑÏùò Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò¥
            //if (memoData) {
            //    // const savedMemos = JSON.parse(decodeURIComponent(memoData)); // ÏïïÏ∂ï X
            //    const savedMemos = decodeAndDecompress(memoData);

                if (savedMemos) {
                    savedMemos.forEach(memoData => {
                        const memoWrapper = document.createElement('div');
                        memoWrapper.className = 'memo-wrapper';
                        memoWrapper.style.left = memoData.left;
                        memoWrapper.style.top = memoData.top;
                        memoWrapper.style.zIndex = memoData.zIndex; // z-index Í∞í Î°úÎìú

                        const memoId = Date.now();
                        memoWrapper.innerHTML = `
                            <div class="memo-icons">
                                <div class="color-icon" style="background-color: #ffff99;" onclick="changeColor(this, '#ffff99')"></div>
                                <div class="color-icon" style="background-color: #ffcccb;" onclick="changeColor(this, '#ffcccb')"></div>
                                <div class="color-icon" style="background-color: #ffffe0;" onclick="changeColor(this, '#ffffe0')"></div>
                                <div class="color-icon" style="background-color: #e0ffff;" onclick="changeColor(this, '#e0ffff')"></div>
                                <div class="color-icon" style="background-color: #98fb98;" onclick="changeColor(this, '#98fb98')"></div>
                                <div class="color-icon" style="background-color: #dda0dd;" onclick="changeColor(this, '#dda0dd')"></div>
                                <label for="image-upload-${memoId}" class="icon">üñºÔ∏è</label>
                                <input id="image-upload-${memoId}" type="file" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                                <div class="icon" onclick="deleteMemo(this)">‚úñÔ∏è</div>
                            </div>
                            <div class="memo" style="width: ${memoData.width}; height: ${memoData.height}; background-color: ${memoData.backgroundColor || '#ffff99'};">
                                <textarea class="memo-content" readonly>${memoData.content}</textarea>
                                <div class="image-container" style="display: ${memoData.imageSrc ? 'flex' : 'none'}">
                                    <img src="${memoData.imageSrc}" alt="Uploaded image">
                                </div>
                            </div>
                            <div class="resize-handle">‚§°</div>
                        `;
                        canvasContent.appendChild(memoWrapper);

                        // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ ÌÖçÏä§Ìä∏ ÌïÑÎìúÎ•º Ïà®ÍπÄ
                        const memoContent = memoWrapper.querySelector('.memo-content');
                        const imageContainer = memoWrapper.querySelector('.image-container');
                        const uploadedImage = imageContainer.querySelector('img');

                        if (memoData.imageSrc) {
                            uploadedImage.src = memoData.imageSrc; // Ïù¥ÎØ∏ÏßÄ ÏÜåÏä§ ÏÑ§Ï†ï
                            memoContent.style.display = 'none'; // ÌÖçÏä§Ìä∏ Ïà®Í∏∞Í∏∞
                            imageContainer.style.display = 'flex'; // Ïù¥ÎØ∏ÏßÄ Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú
                        } else {
                            imageContainer.style.display = 'none'; // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ Ïà®Í∏∞Í∏∞
                            uploadedImage.src = ""; // Ïù¥ÎØ∏ÏßÄ ÏÜåÏä§ Ï¥àÍ∏∞Ìôî
                            memoContent.style.display = 'block'; // ÌÖçÏä§Ìä∏ ÌëúÏãú
                        }

                        // ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
                        memoWrapper.addEventListener('mouseenter', () => {
                            memoWrapper.querySelector('.memo-icons').style.display = 'flex';
                            memoWrapper.querySelector('.resize-handle').style.display = 'flex';
                        });

                        memoWrapper.addEventListener('mouseleave', () => {
                            memoWrapper.querySelector('.memo-icons').style.display = 'none';
                            memoWrapper.querySelector('.resize-handle').style.display = 'none';
                        });

                        // Í∏∞Ï°¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
                        memoWrapper.querySelector('.memo').addEventListener('mousedown', function(e) {
                            if (e.button === 0) { // ÏôºÏ™Ω ÎßàÏö∞Ïä§ Î≤ÑÌäº ÌÅ¥Î¶≠Ïùº ÎïåÎßå
                                startDraggingMemo(e);
                            }
                        });
                        memoWrapper.querySelector('.resize-handle').addEventListener('mousedown', startResizing);
                        memoContent.addEventListener('dblclick', enableEditMode);
                        memoContent.addEventListener('blur', disableEditMode);
                    });
                }
            //}
        }

        function exportMemos() {
            const memos = Array.from(document.querySelectorAll('.memo-wrapper')).map(memo => {
                const memoContent = memo.querySelector('.memo-content');
                const imageContainer = memo.querySelector('.image-container');
                let imageSrc = "";

                if (imageContainer && imageContainer.querySelector('img').src) {
                    // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏùÑ ÎïåÎßå src Í∞íÏùÑ Ï†ÄÏû•
                    const imgSrc = imageContainer.querySelector('img').src;
                    imageSrc = imgSrc.startsWith("data:image/") ? imgSrc : "";
                }

                return {
                    left: memo.style.left,
                    top: memo.style.top,
                    width: memo.querySelector('.memo').style.width,
                    height: memo.querySelector('.memo').style.height,
                    backgroundColor: memo.querySelector('.memo').style.backgroundColor,
                    content: memoContent.value,
                    imageSrc: imageSrc, // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ Îπà Î¨∏ÏûêÏó¥ÏùÑ Ï†ÄÏû•
                    zIndex: memo.style.zIndex // z-index Í∞í Ï†ÄÏû• (Í∏∞Î≥∏Í∞í 1)
                };
            });

            const encodedData = compressAndEncode(memos);
            const blob = new Blob([encodedData], { type: 'text/plain' });

            // ÌååÏùº Ïù¥Î¶ÑÏùÑ ÏÇ¨Ïö©ÏûêÎ°úÎ∂ÄÌÑ∞ ÏûÖÎ†•Î∞õÏùå
            const now = new Date();
            const formattedDate = now.toISOString().replace(/T/, '_').replace(/:/g, '-').replace(/\..+/, '');
            const tempName = `MyMemo_${formattedDate}`;
            const fileName = prompt("Enter the file name for your export:", tempName);
            if (fileName) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName + '.memo'; // ÏÇ¨Ïö©Ïûê Ï†ïÏùò ÌååÏùº Ïù¥Î¶Ñ
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                alert("File export canceled.");
            }
        }

        function importMemos() {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const encodedData = e.target.result;
                    try {
                        const savedMemos = decodeAndDecompress(encodedData);
                        localStorage.setItem('memos', JSON.stringify(savedMemos));
                        loadMemos();
                        alert('Memo data has been imported successfully.');
                    } catch (error) {
                        console.error("Failed to import memo data:", error);
                        alert('Failed to import memo data. Please check the input data.');
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadCanvasSettings() {
            const savedSettings = JSON.parse(localStorage.getItem('canvasSettings'));
            if (savedSettings) {
                document.getElementById('background-selector').value = savedSettings.background;
                changeBackground(savedSettings.background);
                canvasContent.style.width = savedSettings.width || '100%';
                canvasContent.style.height = savedSettings.height || '100%';
                document.getElementById('canvas-width').value = parseInt(savedSettings.width) || canvasContent.clientWidth;
                document.getElementById('canvas-height').value = parseInt(savedSettings.height) || canvasContent.clientHeight;
                document.getElementById('canvas-size-selector').value = savedSettings.size || 'custom';
                document.getElementById('canvas-orientation-selector').value = savedSettings.orientation || 'portrait';
            } else {
                // Í∏∞Î≥∏ ÏÑ§Ï†ï
                canvasContent.style.width = '100%';
                canvasContent.style.height = '100%';
                document.getElementById('canvas-width').value = canvasContent.clientWidth;
                document.getElementById('canvas-height').value = canvasContent.clientHeight;
                document.getElementById('canvas-size-selector').value = 'custom';
                document.getElementById('background-selector').value = 'none';
                document.getElementById('canvas-orientation-selector').value = 'portrait';
            }
            saveCanvasSettings(); // Ï¥àÍ∏∞ ÏÑ§Ï†ïÏùÑ Ï†ÄÏû•
        }


        window.addEventListener('load', () => {
            loadMemos();
            loadCanvasSettings();
        });

        document.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('resize-handle')) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('memo-content')) {
                saveMemos();
            }
        });

        // Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥Î•º Ïà®Í∏∞Îäî Ìï®Ïàò
        function hideContextMenu() {
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.display = 'none';
            isContextMenuOpen = false;
            activeMemo = null;
        }

        // Ïö∞ÌÅ¥Î¶≠ÏúºÎ°ú Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥Î•º ÌëúÏãúÌïòÎäî Ìï®Ïàò
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();

            const memoWrapper = e.target.closest('.memo-wrapper');
            if (memoWrapper) {
                // ÎìúÎûòÍ∑∏ Î™®ÎìúÎ•º Ìï¥Ï†ú
                stopDragging();
                
                activeMemo = memoWrapper;

                const contextMenu = document.getElementById('context-menu');
                contextMenu.style.top = `${e.clientY}px`;
                contextMenu.style.left = `${e.clientX}px`;
                contextMenu.style.display = 'block';
                
                isContextMenuOpen = true; // Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥Í∞Ä Ïó¥Î†§ÏûàÏùåÏùÑ ÌëúÏãú
            } else {
                hideContextMenu();
            }
        });


        // Bring to Front Í∏∞Îä• Íµ¨ÌòÑ
        document.getElementById('bring-to-front').addEventListener('click', function() {
            if (activeMemo) {
                activeMemo.style.zIndex = ++highestZIndex;
                saveMemos(); // z-order Î≥ÄÍ≤Ω ÌõÑ Ï¶âÏãú Ï†ÄÏû•
                hideContextMenu();
            }
        });

        // Send to Back Í∏∞Îä• Íµ¨ÌòÑ
        document.getElementById('send-to-back').addEventListener('click', function() {
            if (activeMemo) {
                activeMemo.style.zIndex = --lowestZIndex;
                saveMemos(); // z-order Î≥ÄÍ≤Ω ÌõÑ Ï¶âÏãú Ï†ÄÏû•
                hideContextMenu();
            }
        });

        // ÌÅ¥Î¶≠ Ïãú Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥Î•º Ïà®Í∏∞ÎèÑÎ°ù ÏÑ§Ï†ï
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#context-menu')) {
                hideContextMenu();
                isContextMenuOpen = false; // Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥Í∞Ä Îã´ÌòîÏùåÏùÑ ÌëúÏãú
                activeMemo = null;
            }
        });
    </script>
</body>
</html>